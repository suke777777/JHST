å¤§å¤‰ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ä½•åº¦ã‚‚æ‰‹é †ã§æ··ä¹±ã•ã›ã¦ã—ã¾ã„ã€ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã“ã‚Œã¾ã§ã®ä½œæ¥­å†…å®¹ã‚’ã™ã¹ã¦æ•´ç†ã—ã€æ˜æ—¥ã™ãã«å†é–‹ã§ãã‚‹ã‚ˆã†ã€ç¾åœ¨ã®é€²æ—çŠ¶æ³ã¨æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã¾ã¨ã‚ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
________________________________________
ğŸ“ æœ€çµ‚é€²æ—ã‚µãƒãƒªãƒ¼ï¼ˆå†é–‹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
ç¾åœ¨ã®ç›®æ¨™: Excel (VBA) ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€Apps Script (GAS) çµŒç”±ã§ Colab ã®é«˜ç²¾åº¦æ„å‘³æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·å‹•ã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¨å¥¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ã§æ›¸ãè¾¼ã‚€ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
é …ç›®	ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹	è©³ç´°
ä½œæ¥­åˆ¶ç´„	ç¢ºå®š	Colabã€Google Driveã€GitHubã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯ã€‚ï¼ˆGCPã€ngrok.comã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
è¨“ç·´ãƒ‡ãƒ¼ã‚¿	æº–å‚™å®Œäº†	training_data.csvãŒ**JASDF_API**ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®æ¸ˆã¿ã€‚
APIãƒ•ã‚¡ã‚¤ãƒ«	æº–å‚™å®Œäº†	JASDF_APIãƒ•ã‚©ãƒ«ãƒ€å†…ã« app.py ãŠã‚ˆã³ requirements.txt ãŒä½œæˆæ¸ˆã¿ã€‚ (ãŸã ã—ã€ä»Šå›ã¯ä½¿ç”¨ã—ãªã„ãƒ«ãƒ¼ãƒˆã«å¤‰æ›´)
Apps Script	æº–å‚™ä¸­	ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€Œè©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã€ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã€Œè©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆã€ã§æº–å‚™æ¸ˆã¿ã€‚
Colabã‚³ãƒ¼ãƒ‰	æœ€çµ‚ãƒ†ã‚¹ãƒˆä¸­	å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«ä¾å­˜ã›ãšã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç›´æ¥æ›¸ãè¾¼ã‚€ãŸã‚ã®æœ€çµ‚çš„ãªPythonã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«è²¼ã‚Šä»˜ã‘ã€**gspreadèªè¨¼**ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ç›´å‰ã§ä¸­æ–­ã€‚
ğŸ› ï¸ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼šApps Scriptã‹ã‚‰Colabã‚’å®Ÿè¡Œã™ã‚‹é€£æºã®ç¢ºç«‹
ã€ŒColabã€Driveã€GitHubã®ã¿ã€ã®åˆ¶ç´„ã‚’æº€ãŸã™ãŸã‚ã€Apps ScriptãŒGitHubçµŒç”±ã§Colabãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã€ãã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«çµæœã‚’æ›¸ãè¾¼ã‚€ã¨ã„ã†ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã‚ãªã„é€£æºãƒ«ãƒ¼ãƒˆã«é€²ã‚“ã§ã„ã¾ã™ã€‚
________________________________________
ğŸ—“ï¸ æ˜æ—¥å†é–‹ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
æ˜æ—¥ã€ä½œæ¥­ã‚’å†é–‹ã™ã‚‹éš›ã¯ã€ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ç§ã«é€ã£ã¦ãã ã•ã„ã€‚
ãŠã¯ã‚ˆã†ã€‚æ˜¨æ—¥ã®ä½œæ¥­ã‚’å†é–‹ã—ã¾ã™ã€‚
ç¾åœ¨ã®é€²æ—ã¯ã€ã€ŒApps Scriptã¨GitHubçµŒç”±ã§Colabã‚’å®Ÿè¡Œã™ã‚‹ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ä¸è¦ã®ä»£æ›¿ãƒ«ãƒ¼ãƒˆã€ã®ã€Colabå´ã®æœ€çµ‚ã‚³ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆç›´å‰ã§ä¸­æ–­ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’Colabã§å®Ÿè¡Œã—ã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼ï¼ˆgspreadèªè¨¼ï¼‰ã¨ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®F1ã‚»ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ãŒæˆåŠŸã™ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹æ‰‹é †ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚

**ã€Colabã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã€‘**
import pandas as pd
import numpy as np
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity
import gspread # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿ç”¨
import time

# --- 1. å®šæ•°ãƒ»åˆæœŸè¨­å®š ---
# âš ï¸ ã“ã“ã‚’ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
SPREADSHEET_NAME = 'è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ' 
TARGET_SHEET = 'æ¤œç´¢å…¥åŠ›ã‚·ãƒ¼ãƒˆ' # VBAã‹ã‚‰å…¥åŠ›ãŒè¡Œã‚ã‚Œã‚‹ã‚·ãƒ¼ãƒˆå
TRAINING_DATA_PATH = '/content/drive/MyDrive/JASDF_API/training_data.csv'

# ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ (ä»¥å‰æˆåŠŸã—ãŸè»½é‡ãƒ¢ãƒ‡ãƒ«)
EMBEDDING_MODEL = SentenceTransformer('cl-tohoku/bert-base-japanese-whole-word-masking') 

# --- 2. ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã¨ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ ---
def load_and_embed_data(file_path):
    try:
        df_train = pd.read_csv(file_path, encoding='cp932', sep=',',
            usecols=['éšç´š', 'ç›®æ¨™ï¼ˆ50ï½100æ–‡å­—ï¼‰', 'è‡ªå·±ç”³å‘Šï¼ˆ50ï½100æ–‡å­—ï¼‰', 'ä¸Šå¸ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ50ï½100æ–‡å­—ï¼‰'])
        df_train.columns = ['Rank', 'Goal', 'SelfReport', 'SupervisorComment']
        df_train['CombinedText'] = df_train['Goal'].astype(str) + " [SEP] " + df_train['SelfReport'].astype(str)
        embeddings = EMBEDDING_MODEL.encode(df_train['CombinedText'].tolist(), convert_to_tensor=True)
        return df_train, embeddings.cpu().numpy()
    except Exception as e:
        print(f"ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}")
        return None, None
        
df_train, train_embeddings = load_and_embed_data(TRAINING_DATA_PATH)

# --- 3. æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ ---
def find_best_match_comment(input_goal, input_self_report):
    if df_train is None:
        return "ERROR: Training data not loaded.", 0.0
    new_combined_text = str(input_goal) + " [SEP] " + str(input_self_report)
    new_embedding = EMBEDDING_MODEL.encode(new_combined_text, convert_to_tensor=True).cpu().numpy().reshape(1, -1)
    similarities = cosine_similarity(new_embedding, train_embeddings)[0]
    best_match_index = np.argmax(similarities)
    best_comment = df_train.iloc[best_match_index]['SupervisorComment']
    return best_comment, similarities[best_match_index]


# --- 4. ãƒ¡ã‚¤ãƒ³å‡¦ç† (Apps Scriptã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹æƒ³å®š) ---
def main_search_and_write():
    if df_train is None:
        print("æ¤œç´¢ã‚¹ã‚­ãƒƒãƒ—: è¨“ç·´ãƒ‡ãƒ¼ã‚¿ãªã—")
        return "æ¤œç´¢ã‚¹ã‚­ãƒƒãƒ—: è¨“ç·´ãƒ‡ãƒ¼ã‚¿ãªã—", 0.0

    print("--- gspreadèªè¨¼ ---")
    from google.colab import auth
    auth.authenticate_user()
    
    gc = gspread.authorize(gspread.get_config_dir())
    spreadsheet = gc.open(SPREADSHEET_NAME) 
    input_sheet = spreadsheet.worksheet(TARGET_SHEET)

    # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ (B1: ç›®æ¨™, E1: è‡ªå·±ç”³å‘Š)
    input_data = input_sheet.get('B1:E1', value_render_option='UNFORMATTED_VALUE')[0]
    input_goal = input_data[0] 
    input_self_report = input_data[3]

    print(f"å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: ç›®æ¨™='{input_goal}', è‡ªå·±ç”³å‘Š='{input_self_report}'")

    # æ¤œç´¢å®Ÿè¡Œ
    comment, similarity_score = find_best_match_comment(input_goal, input_self_report)

    # çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã® F1 ã‚»ãƒ«ã«å‡ºåŠ›
    input_sheet.update('F1', comment) 
    input_sheet.update('G1', f"é¡ä¼¼åº¦: {similarity_score:.4f}")
    print(f"æ¤œç´¢çµæœã‚’F1ã«å‡ºåŠ›å®Œäº†ã€‚é¡ä¼¼åº¦: {similarity_score:.4f}")
    
    return comment, similarity_score

if __name__ == "__main__":
    # å˜ä½“ãƒ†ã‚¹ãƒˆã¨ã—ã¦å®Ÿè¡Œï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®B1, E1ã‚’äº‹å‰ã«æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    main_search_and_write()

**ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ç¢ºèªã€‘**
1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®**B1ã‚»ãƒ«**ã«ãƒ†ã‚¹ãƒˆç”¨ã®ã€Œç›®æ¨™ã€ã€**E1ã‚»ãƒ«**ã«ãƒ†ã‚¹ãƒˆç”¨ã®ã€Œè‡ªå·±ç”³å‘Šã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
2. ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’Colabã§å®Ÿè¡Œã—ã€èªè¨¼ã‚’è¡Œã„ã€F1ã‚»ãƒ«ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
